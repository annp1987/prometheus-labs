version: '2'

services:

  alertmanager:
    image: prom/alertmanager
    hostname: alertmanager
    container_name: alertmanager
    volumes:
      - ./alertmanager/data:/alertmanager
      - ./alertmanager/conf/config.yml:/etc/alertmanager/config.yml

  prometheus:
    image: prom/prometheus:v2.1.0
    hostname: prometheus
    container_name: prometheus
    ports:
      - 9090:9090
    volumes:
      - ./prometheus/conf:/etc/prometheus
      - ./prometheus/data:/prometheus

  grafana:
    image: grafana/grafana:4.6.3
    hostname: grafana
    container_name: grafana
    depends_on:
      - prometheus
    ports:
      - 3000:3000
    volumes:
      - ./grafana/data:/var/lib/grafana

  kafka:
    image: jazzwang/kafka:latest
    hostname: kafka
    container_name: kafka
    ports:
      - 2181:2181
      - 9092:9092
    volumes:
      - ./kafka-broker:/etc/kafka
    environment:
      - KAFKA_OPTS=-javaagent:/etc/kafka/jmx_prometheus_javaagent.jar=7071:/etc/kafka/kafka-jmx.yml
      - JMX_PORT=9999

  kafka-manager:
    image: sheepkiller/kafka-manager
    hostname: kafka-manager
    container_name: kafka-manager
    ports:
      - 9000:9000
    environment:
      - ZK_HOSTS=kafka:2181
      - JAVA_OPTS=-Xmx512m
      - APPLICATION_SECRET=letmein

  kafka-exporter:
    build: ./kafka-exporter
    image: jazzwang/kafka-exporter:0.1.0
    hostname: kafka-exporter
    container_name: kafka-exporter
    command: /usr/bin/kafka_exporter -zookeeper-connect kafka:2181 -listen-address ':9101'

  cassandra:
    image: cassandra
    hostname: cassandra
    container_name: cassandra
    volumes:
      - ./cassandra:/data/cassandra
    environment:
      - JVM_OPTS=-javaagent:/data/cassandra/jmx_prometheus_javaagent.jar=7070:/data/cassandra/cdra-jmx.yml

  fluentd:
    build: ./fluentd
    image: jazzwang/fluentd:v1.0
    hostname: fluentd
    container_name: fluentd
    depends_on:
      - kafka
    volumes:
      - ./fluentd/etc:/fluentd/etc
      - ./fluentd/data:/tmp

  fluentd-exporter:
    build: ./fluentd-exporter
    image: jazzwang/fluentd-exporter:0.1.0
    hostname: fluentd-exporter
    container_name: fluentd-exporter
    depends_on:
      - fluentd
    command: fluentd_exporter -scrape_uri http://fluentd:24220/api/plugins.json
